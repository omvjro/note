<!DOCTYPE html><html lang="zh-CN" id="html"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><title>omvjro<!-- -->&#x27;s website</title><meta name="next-head-count" content="3"/><link rel="shortcut icon" href="./favicon.ico"/><link data-next-font="" rel="preconnect" href="/" crossorigin="anonymous"/><link rel="preload" href="/note/_next/static/css/15c171605c09b7dc.css" as="style" crossorigin=""/><link rel="stylesheet" href="/note/_next/static/css/15c171605c09b7dc.css" crossorigin="" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" crossorigin="" nomodule="" src="/note/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/note/_next/static/chunks/webpack-814f3a0949786058.js" defer="" crossorigin=""></script><script src="/note/_next/static/chunks/framework-ed66dd8a32a1d8f6.js" defer="" crossorigin=""></script><script src="/note/_next/static/chunks/main-64d31a590a51b8f1.js" defer="" crossorigin=""></script><script src="/note/_next/static/chunks/pages/_app-28f7a80823b66374.js" defer="" crossorigin=""></script><script src="/note/_next/static/chunks/610-289babee075c1094.js" defer="" crossorigin=""></script><script src="/note/_next/static/chunks/914-0029599c095eb92c.js" defer="" crossorigin=""></script><script src="/note/_next/static/chunks/pages/post/%5Bid%5D-dfd04df4139e7733.js" defer="" crossorigin=""></script><script src="/note/_next/static/CUaEogwWMroIdI9PZB-NQ/_buildManifest.js" defer="" crossorigin=""></script><script src="/note/_next/static/CUaEogwWMroIdI9PZB-NQ/_ssgManifest.js" defer="" crossorigin=""></script></head><body class="dark:bg-black bg-slate-50"><div id="__next"><script>!function(){try{var d=document.documentElement,n='data-theme',s='setAttribute';var e=localStorage.getItem('theme');if('system'===e||(!e&&true)){var t='(prefers-color-scheme: dark)',m=window.matchMedia(t);if(m.media!==t||m.matches){d.style.colorScheme = 'dark';d[s](n,'dark')}else{d.style.colorScheme = 'light';d[s](n,'light')}}else if(e){d[s](n,e|| '')}if(e==='light'||e==='dark')d.style.colorScheme=e}catch(e){}}()</script><div class="flex flex-col h-screen container w-full md:w-3/4 xl:w-1/2"><header><div class="my-10 flex self-center flex-row justify-between"><div class="flex self-center flex-row justify-between"><a class="md:text-2xl text-xl cursor-pointer dark:hover:text-white dark:text-gray-400 text-gray-500 hover:text-black transition-colors duration-200 font-en" href="/note">cd ..</a></div><div class="self-center text-sm sm:text-lg"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="2em" height="2em" viewBox="0 0 24 24" class="cursor-pointer"><path fill="currentColor" d="M12 5q-.425 0-.712-.288Q11 4.425 11 4V2q0-.425.288-.713Q11.575 1 12 1t.713.287Q13 1.575 13 2v2q0 .425-.287.712Q12.425 5 12 5Zm4.95 2.05q-.275-.275-.275-.688q0-.412.275-.712l1.4-1.425q.3-.3.712-.3q.413 0 .713.3q.275.275.275.7q0 .425-.275.7L18.35 7.05q-.275.275-.7.275q-.425 0-.7-.275ZM20 13q-.425 0-.712-.288Q19 12.425 19 12t.288-.713Q19.575 11 20 11h2q.425 0 .712.287q.288.288.288.713t-.288.712Q22.425 13 22 13Zm-8 10q-.425 0-.712-.288Q11 22.425 11 22v-2q0-.425.288-.712Q11.575 19 12 19t.713.288Q13 19.575 13 20v2q0 .425-.287.712Q12.425 23 12 23ZM5.65 7.05l-1.425-1.4q-.3-.3-.3-.725t.3-.7q.275-.275.7-.275q.425 0 .7.275L7.05 5.65q.275.275.275.7q0 .425-.275.7q-.3.275-.7.275q-.4 0-.7-.275Zm12.7 12.725l-1.4-1.425q-.275-.3-.275-.712q0-.413.275-.688q.275-.275.688-.275q.412 0 .712.275l1.425 1.4q.3.275.287.7q-.012.425-.287.725q-.3.3-.725.3t-.7-.3ZM2 13q-.425 0-.712-.288Q1 12.425 1 12t.288-.713Q1.575 11 2 11h2q.425 0 .713.287Q5 11.575 5 12t-.287.712Q4.425 13 4 13Zm2.225 6.775q-.275-.275-.275-.7q0-.425.275-.7L5.65 16.95q.275-.275.688-.275q.412 0 .712.275q.3.3.3.713q0 .412-.3.712l-1.4 1.4q-.3.3-.725.3t-.7-.3ZM12 18q-2.5 0-4.25-1.75T6 12q0-2.5 1.75-4.25T12 6q2.5 0 4.25 1.75T18 12q0 2.5-1.75 4.25T12 18Zm0-2q1.65 0 2.825-1.175Q16 13.65 16 12q0-1.65-1.175-2.825Q13.65 8 12 8q-1.65 0-2.825 1.175Q8 10.35 8 12q0 1.65 1.175 2.825Q10.35 16 12 16Z"></path></svg></div></div></header><main class="grow"><div><div class="flex flex-col mb-2"><div class="text-4xl sm:text-4xl font-medium dark:text-gray-200">在维基农场上为初始语言并非 zh 的 MediaWiki 站点添加语言变体/简繁转换功能</div><div class="sm:text-lg text-sm mt-2 dark:text-gray-400"><span>5月13日</span> / <span>5月13日</span></div></div><br/><div class="font-normal"><p node="[object Object]" class="sm:text-xl text-lg mt-4 dark:text-gray-300">在 <a href="https://degreesoflewditycn.miraheze.org/" node="[object Object]" class="text-blue-500 hover:text-blue-800 after:content-[&#x27;_↗&#x27;] transition-colors duration-200">DOL 中文 wiki</a> 中，或由于初始设置失误，语言设置为 <code class="text-gray-600 dark:text-white" node="[object Object]">`<!-- -->zh-CN<!-- -->`</code> 而非 <code class="text-gray-600 dark:text-white" node="[object Object]">`<!-- -->zh<!-- -->`</code>。根据 <a href="https://www.mediawiki.org/wiki/Manual:$wgDisableLangConversion/zh" node="[object Object]" class="text-blue-500 hover:text-blue-800 after:content-[&#x27;_↗&#x27;] transition-colors duration-200">MediaWiki 文档</a>，只有语言设置为 <code class="text-gray-600 dark:text-white" node="[object Object]">`<!-- -->zh<!-- -->`</code> 才能启用自带的变体转换功能（以 <code class="text-gray-600 dark:text-white" node="[object Object]">`<!-- -->$wgDisableLangConversion<!-- -->`</code> 设置）。</p>
<div class="mt-12 mb-6"><h2 class="sm:text-3xl text-2xl dark:text-white">用户界面语言和站点内容语言</h2><hr class="dark:border-dashed mt-1"/></div>
<p node="[object Object]" class="sm:text-xl text-lg mt-4 dark:text-gray-300">首先需由<a href="https://www.mediawiki.org/wiki/Manual:Language" node="[object Object]" class="text-blue-500 hover:text-blue-800 after:content-[&#x27;_↗&#x27;] transition-colors duration-200">文档</a>明确，MediaWiki 的语言分为三种：</p>
<ul depth="0" node="[object Object]" class="sm:text-xl text-lg list-disc pl-5 my-5 dark:text-gray-300">
<li class="ml-2 my-1">站点内容语言（Site content language）</li>
<li class="ml-2 my-1">用户界面语言（User interface language，API 调用为 <code class="text-gray-600 dark:text-white" node="[object Object]">`<!-- -->mw.user.options.values.language<!-- -->`</code>）</li>
<li class="ml-2 my-1">页面内容语言（Page content language）</li>
</ul>
<p node="[object Object]" class="sm:text-xl text-lg mt-4 dark:text-gray-300">其中页面内容语言极少需要配置，绝大部分情况下，都默认与 <code class="text-gray-600 dark:text-white" node="[object Object]">`<!-- -->站点内容语言<!-- -->`</code> 一致，在此忽略。</p>
<p node="[object Object]" class="sm:text-xl text-lg mt-4 dark:text-gray-300"><code class="text-gray-600 dark:text-white" node="[object Object]">`<!-- -->站点内容语言<!-- -->`</code> 决定了 <code class="text-gray-600 dark:text-white" node="[object Object]">`<!-- -->html<!-- -->`</code> 的 <code class="text-gray-600 dark:text-white" node="[object Object]">`<!-- -->lang<!-- -->`</code> 属性，在默认情况下，也决定了 wiki 具体内容的语言，实际使用上，主要有标题（<code class="text-gray-600 dark:text-white" node="[object Object]">`<!-- -->#firstHeading<!-- -->`</code>）和内容（<code class="text-gray-600 dark:text-white" node="[object Object]">`<!-- -->#mw-content-text<!-- -->`</code>）两部分。</p>
<p node="[object Object]" class="sm:text-xl text-lg mt-4 dark:text-gray-300"><code class="text-gray-600 dark:text-white" node="[object Object]">`<!-- -->用户界面语言<!-- -->`</code> 决定了基础界面的 <code class="text-gray-600 dark:text-white" node="[object Object]">`<!-- -->lang<!-- -->`</code> 属性，这些基础界面也就是“用户界面消息”（User interface message）。用户界面消息大部分由 MediaWiki 自动生成，例如命名空间的“User”（<code class="text-gray-600 dark:text-white" node="[object Object]">`<!-- -->en<!-- -->`</code>）和“用户”（<code class="text-gray-600 dark:text-white" node="[object Object]">`<!-- -->zh<!-- -->`</code>），能够随 <code class="text-gray-600 dark:text-white" node="[object Object]">`<!-- -->用户界面语言<!-- -->`</code> 改变自己改变语言；但有一部分用户界面消息来自 MediaWiki 命名空间，最常用的如 <code class="text-gray-600 dark:text-white" node="[object Object]">`<!-- -->MediaWiki:Sidebar<!-- -->`</code> 为侧边栏（<code class="text-gray-600 dark:text-white" node="[object Object]">`<!-- -->#site-navigation<!-- -->`</code>），其 <code class="text-gray-600 dark:text-white" node="[object Object]">`<!-- -->lang<!-- -->`</code> 属性虽能随 <code class="text-gray-600 dark:text-white" node="[object Object]">`<!-- -->用户界面语言<!-- -->`</code> 改变而改变，具体内容却不会自动变化，需要额外设置用户界面消息。</p>
<div class="mt-12 mb-6"><h2 class="sm:text-3xl text-2xl dark:text-white">清除用户界面消息缓存</h2><hr class="dark:border-dashed mt-1"/></div>
<p node="[object Object]" class="sm:text-xl text-lg mt-4 dark:text-gray-300">作为往往在每个页面都有使用的内容，用户界面消息有着强大的缓存。根据 <a href="https://www.mediawiki.org/wiki/Manual:$wgLanguageCode" node="[object Object]" class="text-blue-500 hover:text-blue-800 after:content-[&#x27;_↗&#x27;] transition-colors duration-200">MediaWiki 文档</a>，更改 wiki 语言（<code class="text-gray-600 dark:text-white" node="[object Object]">`<!-- -->$wgLanguageCode<!-- -->`</code>）后，需清除用户界面消息缓存，否则会无法显示新语言界面消息，或新旧语言界面消息混杂。其中提供了两种方法。</p>
<p node="[object Object]" class="sm:text-xl text-lg mt-4 dark:text-gray-300">在 MediaWiki 1.18 及以上，运行</p>
<pre><div node="[object Object]" style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:1.8rem 0;overflow:auto;border-radius:0.5rem"><code class="font-en text-md" style="white-space:pre"><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">1</span><span class="token" style="color:#DD4A68">echo</span><span> </span><span class="token" style="color:#690">&#x27;MediaWiki\MediaWikiServices::getInstance()-&gt;getMessageCache()-&gt;clear()&#x27;</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">|</span><span> php maintenance/eval.php</span></code></div></pre>
<p node="[object Object]" class="sm:text-xl text-lg mt-4 dark:text-gray-300">在 MediaWiki 1.18 以下，则手动运行 <code class="text-gray-600 dark:text-white" node="[object Object]">`<!-- -->maintenance/rebuildmessages.php<!-- -->`</code>。</p>
<p node="[object Object]" class="sm:text-xl text-lg mt-4 dark:text-gray-300">在 Miraheze 这样的维基农场中，往往无法如此清除缓存，需要等待很长时间自动清除，可能会对期间访问站点的用户造成困扰。</p>
<div class="mt-12 mb-6"><h2 class="sm:text-3xl text-2xl dark:text-white">设置 <code class="text-gray-600 dark:text-white" node="[object Object]">`<!-- -->$wgForceUIMsgAsContentMsg<!-- -->`</code></h2><hr class="dark:border-dashed mt-1"/></div>
<p node="[object Object]" class="sm:text-xl text-lg mt-4 dark:text-gray-300">经指点并查<a href="https://www.mediawiki.org/wiki/Manual:$wgForceUIMsgAsContentMsg" node="[object Object]" class="text-blue-500 hover:text-blue-800 after:content-[&#x27;_↗&#x27;] transition-colors duration-200">文档</a>，亦可以设置 <code class="text-gray-600 dark:text-white" node="[object Object]">`<!-- -->$wgForceUIMsgAsContentMsg<!-- -->`</code>，将用户界面消息设置为内容消息，即能够自己转换。</p>
<p node="[object Object]" class="sm:text-xl text-lg mt-4 dark:text-gray-300">显然，在维基农场中，也不可改动这个设置。</p>
<div class="mt-12 mb-6"><h2 class="sm:text-3xl text-2xl dark:text-white">编写自定义变体脚本</h2><hr class="dark:border-dashed mt-1"/></div>
<p node="[object Object]" class="sm:text-xl text-lg mt-4 dark:text-gray-300">试模拟原变体功能，在内容页面右上排按钮（<code class="text-gray-600 dark:text-white" node="[object Object]">`<!-- -->.mw-list-item<!-- -->`</code>）中添加变体按钮，加入全站加载的 <code class="text-gray-600 dark:text-white" node="[object Object]">`<!-- -->MediaWiki:Common.js<!-- -->`</code> 中。</p>
<h3 class="sm:text-2xl text-2xl mt-12 mb-6 dark:text-white">opencc-js</h3>
<p node="[object Object]" class="sm:text-xl text-lg mt-4 dark:text-gray-300"><a href="https://github.com/BYVoid/OpenCC" node="[object Object]" class="text-blue-500 hover:text-blue-800 after:content-[&#x27;_↗&#x27;] transition-colors duration-200">OpenCC</a> 是非常常用的一个简繁转换工具，凭借巨大的词库，可以实现各地不同繁体的转换，故欲以此编写转换脚本。原工具为 npm 包，难以直接使用，但有衍生 JavaScript 版本 <a href="https://github.com/nk2028/opencc-js" node="[object Object]" class="text-blue-500 hover:text-blue-800 after:content-[&#x27;_↗&#x27;] transition-colors duration-200">opencc-js</a>，此处则使用此版本。</p>
<p node="[object Object]" class="sm:text-xl text-lg mt-4 dark:text-gray-300">摘抄用法如下：</p>
<pre><div node="[object Object]" style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:1.8rem 0;overflow:auto;border-radius:0.5rem"><code class="font-en text-md" style="white-space:pre"><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">1</span><span class="token" style="color:slategray">// Set Chinese convert from Traditional (Hong Kong) to Simplified (Mainland China)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">2</span><span></span><span class="token" style="color:#07a">const</span><span> converter </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token maybe-class-name">OpenCC</span><span class="token" style="color:#999">.</span><span class="token method property-access maybe-class-name" style="color:#DD4A68">Converter</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">{</span><span> </span><span class="token module" style="color:#07a">from</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token" style="color:#690">&#x27;hk&#x27;</span><span class="token" style="color:#999">,</span><span> </span><span class="token literal-property" style="color:#905">to</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token" style="color:#690">&#x27;cn&#x27;</span><span> </span><span class="token" style="color:#999">}</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">3</span><span></span><span class="token" style="color:slategray">// Set the conversion starting point to the root node, i.e. convert the whole page</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">4</span><span></span><span class="token" style="color:#07a">const</span><span> rootNode </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token dom" style="color:#e90">document</span><span class="token" style="color:#999">.</span><span class="token property-access">documentElement</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">5</span><span></span><span class="token" style="color:slategray">// Convert all elements with attributes lang=&#x27;zh-HK&#x27;. Change attribute value to lang=&#x27;zh-CN&#x27;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">6</span><span></span><span class="token" style="color:#07a">const</span><span> </span><span class="token maybe-class-name">HTMLConvertHandler</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token maybe-class-name">OpenCC</span><span class="token" style="color:#999">.</span><span class="token method property-access maybe-class-name" style="color:#DD4A68">HTMLConverter</span><span class="token" style="color:#999">(</span><span>converter</span><span class="token" style="color:#999">,</span><span> rootNode</span><span class="token" style="color:#999">,</span><span> </span><span class="token" style="color:#690">&#x27;zh-HK&#x27;</span><span class="token" style="color:#999">,</span><span> </span><span class="token" style="color:#690">&#x27;zh-CN&#x27;</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">7</span><span></span><span class="token maybe-class-name">HTMLConvertHandler</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">convert</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span> </span><span class="token" style="color:slategray">// Convert  -&gt; 汉语</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">8</span><span></span><span class="token maybe-class-name">HTMLConvertHandler</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">restore</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span> </span><span class="token" style="color:slategray">// Restore  -&gt; 漢語</span></code></div></pre>
<p node="[object Object]" class="sm:text-xl text-lg mt-4 dark:text-gray-300">由此按照 <code class="text-gray-600 dark:text-white" node="[object Object]">`<!-- -->lang<!-- -->`</code> 属性转换的特性，可以为需转换内容设置不存在的 <code class="text-gray-600 dark:text-white" node="[object Object]">`<!-- -->lang<!-- -->`</code> 属性，如 <code class="text-gray-600 dark:text-white" node="[object Object]">`<!-- -->zh-to-convert<!-- -->`</code>，实现不影响其他部分的转换；对于易误转换的内容，如 <code class="text-gray-600 dark:text-white" node="[object Object]">`<!-- -->textarea<!-- -->`</code>，也可以设置如 <code class="text-gray-600 dark:text-white" node="[object Object]">`<!-- -->zh-not-convert<!-- -->`</code> 的 <code class="text-gray-600 dark:text-white" node="[object Object]">`<!-- -->lang<!-- -->`</code> 属性，随后用 <code class="text-gray-600 dark:text-white" node="[object Object]">`<!-- -->restore<!-- -->`</code> 方法转回原文。</p>
<p node="[object Object]" class="sm:text-xl text-lg mt-4 dark:text-gray-300">特别是在 MediaWiki 中，需要转换的元素主要为标题（<code class="text-gray-600 dark:text-white" node="[object Object]">`<!-- -->#firstHeading<!-- -->`</code>）、侧边栏（<code class="text-gray-600 dark:text-white" node="[object Object]">`<!-- -->#site-navigation<!-- -->`</code>）、内容（<code class="text-gray-600 dark:text-white" node="[object Object]">`<!-- -->#mw-content-text<!-- -->`</code>），这些部分的特点是具有 MediaWiki 根据 <code class="text-gray-600 dark:text-white" node="[object Object]">`<!-- -->站点内容语言<!-- -->`</code> 或 <code class="text-gray-600 dark:text-white" node="[object Object]">`<!-- -->用户界面语言<!-- -->`</code> 设定设置的 <code class="text-gray-600 dark:text-white" node="[object Object]">`<!-- -->lang<!-- -->`</code> 属性；然而，<code class="text-gray-600 dark:text-white" node="[object Object]">`<!-- -->html<!-- -->`</code> 同样拥有此属性，因此不能直接根据原属性转换。</p>
<p node="[object Object]" class="sm:text-xl text-lg mt-4 dark:text-gray-300">opencc-js 亦支持自定义词典，在 wiki 实际使用中应很有用处，但暂不研究。</p>
<h3 class="sm:text-2xl text-2xl mt-12 mb-6 dark:text-white">外部脚本加载问题</h3>
<p node="[object Object]" class="sm:text-xl text-lg mt-4 dark:text-gray-300">MediaWiki 中，传统的引入外部脚本的方式为使用 <code class="text-gray-600 dark:text-white" node="[object Object]">`<!-- -->mw.loader.load<!-- -->`</code>。</p>
<pre><div node="[object Object]" style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:1.8rem 0;overflow:auto;border-radius:0.5rem"><code class="font-en text-md" style="white-space:pre"><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">1</span><span>mw</span><span class="token" style="color:#999">.</span><span class="token property-access">loader</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">load</span><span class="token" style="color:#999">(</span><span> </span><span class="token" style="color:#690">&#x27;https://cdn.jsdelivr.net/npm/opencc-js@1.0.5/dist/umd/full.js&#x27;</span><span> </span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span></code></div></pre>
<p node="[object Object]" class="sm:text-xl text-lg mt-4 dark:text-gray-300">然而，当网络情况不佳或脚本稍大（如 opencc-js）时，会出现未加载完成的情况。</p>
<p node="[object Object]" class="sm:text-xl text-lg mt-4 dark:text-gray-300">幸而，在 MediaWiki 1.33 中，新增了一种引入外部脚本的方式，为 <code class="text-gray-600 dark:text-white" node="[object Object]">`<!-- -->mw.loader.getScript<!-- -->`</code>，其会传回一个 Promise 对象。无需知道 Promise 对象的含义，只需参考<a href="https://www.mediawiki.org/wiki/ResourceLoader/Core_modules#mw.loader.getScript" node="[object Object]" class="text-blue-500 hover:text-blue-800 after:content-[&#x27;_↗&#x27;] transition-colors duration-200">示例代码</a>，就能实现外部脚本加载完后执行函数。</p>
<pre><div node="[object Object]" style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:1.8rem 0;overflow:auto;border-radius:0.5rem"><code class="font-en text-md" style="white-space:pre"><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">1</span><span>mw</span><span class="token" style="color:#999">.</span><span class="token property-access">loader</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">getScript</span><span class="token" style="color:#999">(</span><span> </span><span class="token" style="color:#690">&#x27;https://cdn.jsdelivr.net/npm/opencc-js@1.0.5/dist/umd/full.js&#x27;</span><span> </span><span class="token" style="color:#999">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">2</span><span></span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">then</span><span class="token" style="color:#999">(</span><span class="token" style="color:#07a">function</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">3</span><span>    </span><span class="token" style="color:slategray">// 之后执行的内容</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">4</span><span></span><span class="token" style="color:#999">}</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span></code></div></pre>
<h3 class="sm:text-2xl text-2xl mt-12 mb-6 dark:text-white">只支持 ES5 的屑 MediaWiki</h3>
<p node="[object Object]" class="sm:text-xl text-lg mt-4 dark:text-gray-300">调试时可能出现报错，说明只能使用 ES5 语法。ES6 2015 年即推出，目前已经普遍支持，很容易不小心写出来。例如模板字符串、箭头函数等。</p>
<blockquote node="[object Object]" class="border-l-4 pl-4 border-gray-300 dark:border-gray-600 rounded-l-sm italic my-4">
<p node="[object Object]" class="sm:text-xl text-lg mt-4 dark:text-gray-300">实现目前的需求，将 ES6 语法重构为 ES5 语法不是很难。对于重构困难的脚本，可以通过以 <code class="text-gray-600 dark:text-white" node="[object Object]">`<!-- -->mw.loader.load<!-- -->`</code> 加载脚本的方法在 MediaWiki 中使用 ES6。</p>
</blockquote>
<div class="mt-12 mb-6"><h2 class="sm:text-3xl text-2xl dark:text-white">结果</h2><hr class="dark:border-dashed mt-1"/></div>
<p node="[object Object]" class="sm:text-xl text-lg mt-4 dark:text-gray-300">以下为暂用的脚本，实现以 <code class="text-gray-600 dark:text-white" node="[object Object]">`<!-- -->localStorage<!-- -->`</code> 存储用户偏好的变体转换，理论上可适用于所有 wiki，只需微调 CSS。</p>
<pre><div node="[object Object]" style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:1.8rem 0;overflow:auto;border-radius:0.5rem"><code class="font-en text-md" style="white-space:pre"><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">1</span><span class="token" style="color:slategray">// 载入 openccjs</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">2</span><span>mw</span><span class="token" style="color:#999">.</span><span class="token property-access">loader</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">getScript</span><span class="token" style="color:#999">(</span><span> </span><span class="token" style="color:#690">&#x27;https://cdn.jsdelivr.net/npm/opencc-js@1.0.5/dist/umd/full.js&#x27;</span><span> </span><span class="token" style="color:#999">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">3</span><span></span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">then</span><span class="token" style="color:#999">(</span><span class="token" style="color:#07a">function</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">4</span><span></span><span class="token" style="color:#DD4A68">$</span><span class="token" style="color:#999">(</span><span class="token" style="color:#07a">function</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">{</span><span> </span><span class="token" style="color:slategray">// DOM 加载后操作</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">5</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">6</span><span></span><span class="token" style="color:slategray">// 设置转换工具，简体 -&gt; 港繁/台繁，台繁 -&gt; 简体</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">7</span><span></span><span class="token" style="color:#07a">const</span><span> cth </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token maybe-class-name">OpenCC</span><span class="token" style="color:#999">.</span><span class="token method property-access maybe-class-name" style="color:#DD4A68">Converter</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">{</span><span> </span><span class="token module" style="color:#07a">from</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token" style="color:#690">&#x27;cn&#x27;</span><span class="token" style="color:#999">,</span><span> </span><span class="token literal-property" style="color:#905">to</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token" style="color:#690">&#x27;hk&#x27;</span><span> </span><span class="token" style="color:#999">}</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">8</span><span></span><span class="token" style="color:#07a">const</span><span> ttc </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token maybe-class-name">OpenCC</span><span class="token" style="color:#999">.</span><span class="token method property-access maybe-class-name" style="color:#DD4A68">Converter</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">{</span><span> </span><span class="token module" style="color:#07a">from</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token" style="color:#690">&#x27;tw&#x27;</span><span class="token" style="color:#999">,</span><span> </span><span class="token literal-property" style="color:#905">to</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token" style="color:#690">&#x27;cn&#x27;</span><span> </span><span class="token" style="color:#999">}</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">9</span><span></span><span class="token" style="color:#07a">const</span><span> ctt </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token maybe-class-name">OpenCC</span><span class="token" style="color:#999">.</span><span class="token method property-access maybe-class-name" style="color:#DD4A68">Converter</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">{</span><span> </span><span class="token module" style="color:#07a">from</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token" style="color:#690">&#x27;cn&#x27;</span><span class="token" style="color:#999">,</span><span> </span><span class="token literal-property" style="color:#905">to</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token" style="color:#690">&#x27;tw&#x27;</span><span> </span><span class="token" style="color:#999">}</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">10</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">11</span><span></span><span class="token" style="color:slategray">// 设置必要的 lang 属性以备后续转换</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">12</span><span></span><span class="token" style="color:#DD4A68">$</span><span class="token" style="color:#999">(</span><span class="token" style="color:#690">&#x27;#firstHeading&#x27;</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">attr</span><span class="token" style="color:#999">(</span><span class="token" style="color:#690">&#x27;lang&#x27;</span><span class="token" style="color:#999">,</span><span> </span><span class="token" style="color:#690">&#x27;zh-to-convert&#x27;</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">13</span><span></span><span class="token" style="color:#DD4A68">$</span><span class="token" style="color:#999">(</span><span class="token" style="color:#690">&#x27;#site-navigation ul&#x27;</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">attr</span><span class="token" style="color:#999">(</span><span class="token" style="color:#690">&#x27;lang&#x27;</span><span class="token" style="color:#999">,</span><span> </span><span class="token" style="color:#690">&#x27;zh-to-convert&#x27;</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">14</span><span></span><span class="token" style="color:#DD4A68">$</span><span class="token" style="color:#999">(</span><span class="token" style="color:#690">&#x27;#site-navigation h3&#x27;</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">attr</span><span class="token" style="color:#999">(</span><span class="token" style="color:#690">&#x27;lang&#x27;</span><span class="token" style="color:#999">,</span><span> </span><span class="token" style="color:#690">&#x27;zh-to-convert&#x27;</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">15</span><span></span><span class="token" style="color:#DD4A68">$</span><span class="token" style="color:#999">(</span><span class="token" style="color:#690">&#x27;#mw-content-text&#x27;</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">attr</span><span class="token" style="color:#999">(</span><span class="token" style="color:#690">&#x27;lang&#x27;</span><span class="token" style="color:#999">,</span><span> </span><span class="token" style="color:#690">&#x27;zh-to-convert&#x27;</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">16</span><span></span><span class="token control-flow" style="color:#07a">if</span><span class="token" style="color:#999">(</span><span class="token" style="color:#DD4A68">$</span><span class="token" style="color:#999">(</span><span class="token" style="color:#690">&#x27;textarea&#x27;</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">{</span><span> </span><span class="token" style="color:#DD4A68">$</span><span class="token" style="color:#999">(</span><span class="token" style="color:#690">&#x27;textarea&#x27;</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">attr</span><span class="token" style="color:#999">(</span><span class="token" style="color:#690">&#x27;lang&#x27;</span><span class="token" style="color:#999">,</span><span> </span><span class="token" style="color:#690">&#x27;zh-not-convert&#x27;</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span> </span><span class="token" style="color:#999">}</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">17</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">18</span><span></span><span class="token" style="color:slategray">// 检查 localStorage 并转换</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">19</span><span></span><span class="token" style="color:#07a">const</span><span> rootNode </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token dom" style="color:#e90">document</span><span class="token" style="color:#999">.</span><span class="token property-access">documentElement</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">20</span><span></span><span class="token" style="color:#07a">const</span><span> </span><span class="token maybe-class-name">HTMLConvertHandler</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">21</span><span>    </span><span class="token string-property" style="color:#905">&quot;cn&quot;</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token maybe-class-name">OpenCC</span><span class="token" style="color:#999">.</span><span class="token method property-access maybe-class-name" style="color:#DD4A68">HTMLConverter</span><span class="token" style="color:#999">(</span><span>ttc</span><span class="token" style="color:#999">,</span><span> rootNode</span><span class="token" style="color:#999">,</span><span> </span><span class="token" style="color:#690">&#x27;zh-to-convert&#x27;</span><span class="token" style="color:#999">,</span><span> </span><span class="token" style="color:#690">&#x27;zh-CN&#x27;</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">22</span><span>    </span><span class="token string-property" style="color:#905">&quot;hk&quot;</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token maybe-class-name">OpenCC</span><span class="token" style="color:#999">.</span><span class="token method property-access maybe-class-name" style="color:#DD4A68">HTMLConverter</span><span class="token" style="color:#999">(</span><span>cth</span><span class="token" style="color:#999">,</span><span> rootNode</span><span class="token" style="color:#999">,</span><span> </span><span class="token" style="color:#690">&#x27;zh-to-convert&#x27;</span><span class="token" style="color:#999">,</span><span> </span><span class="token" style="color:#690">&#x27;zh-HK&#x27;</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">23</span><span>    </span><span class="token string-property" style="color:#905">&quot;tw&quot;</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token maybe-class-name">OpenCC</span><span class="token" style="color:#999">.</span><span class="token method property-access maybe-class-name" style="color:#DD4A68">HTMLConverter</span><span class="token" style="color:#999">(</span><span>ctt</span><span class="token" style="color:#999">,</span><span> rootNode</span><span class="token" style="color:#999">,</span><span> </span><span class="token" style="color:#690">&#x27;zh-to-convert&#x27;</span><span class="token" style="color:#999">,</span><span> </span><span class="token" style="color:#690">&#x27;zh-TW&#x27;</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">24</span><span></span><span class="token" style="color:#999">}</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">25</span><span></span><span class="token control-flow" style="color:#07a">if</span><span> </span><span class="token" style="color:#999">(</span><span class="token dom" style="color:#e90">localStorage</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">getItem</span><span class="token" style="color:#999">(</span><span class="token" style="color:#690">&#x27;opencc&#x27;</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">26</span><span>    </span><span class="token maybe-class-name">HTMLConvertHandler</span><span class="token" style="color:#999">[</span><span class="token dom" style="color:#e90">localStorage</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">getItem</span><span class="token" style="color:#999">(</span><span class="token" style="color:#690">&#x27;opencc&#x27;</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">]</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">convert</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">27</span><span>    </span><span class="token" style="color:#DD4A68">$</span><span class="token" style="color:#999">(</span><span class="token" style="color:#690">&#x27;#opencc&#x27;</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">val</span><span class="token" style="color:#999">(</span><span class="token dom" style="color:#e90">localStorage</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">getItem</span><span class="token" style="color:#999">(</span><span class="token" style="color:#690">&#x27;opencc&#x27;</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">28</span><span></span><span class="token" style="color:#999">}</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">29</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">30</span><span></span><span class="token" style="color:slategray">// 插入样式和按钮</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">31</span><span></span><span class="token" style="color:#DD4A68">$</span><span class="token" style="color:#999">(</span><span class="token" style="color:#690">&#x27;&lt;style&gt;.mw-list-item select {color: #68d;padding: inherit;padding-right: 2em;background-color: transparent;cursor: pointer;border: none;}.mw-list-item select:hover {border: none;}&lt;/style&gt;&#x27;</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">appendTo</span><span class="token" style="color:#999">(</span><span class="token" style="color:#690">&#x27;body&#x27;</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">32</span><span></span><span class="token" style="color:#DD4A68">$</span><span class="token" style="color:#999">(</span><span class="token" style="color:#690">&#x27;&lt;li class=&quot;mw-list-item&quot;&gt;&lt;select name=&quot;opencc&quot; id=&quot;opencc&quot;&gt;&lt;option value=&quot;&quot;&gt;不转换&lt;/option&gt;&lt;option value=&quot;cn&quot;&gt;大陆简体&lt;/option&gt;&lt;option value=&quot;hk&quot;&gt;港澳繁体&lt;/option&gt;&lt;option value=&quot;tw&quot;&gt;台湾繁体&lt;/option&gt;&lt;/select&gt;&lt;/li&gt;&#x27;</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">appendTo</span><span class="token" style="color:#999">(</span><span class="token" style="color:#DD4A68">$</span><span class="token" style="color:#999">(</span><span class="token" style="color:#690">&#x27;#p-views ul&#x27;</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">33</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">34</span><span></span><span class="token" style="color:slategray">// 用户修改变体后，设置 localStorage 并刷新</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">35</span><span></span><span class="token" style="color:#DD4A68">$</span><span class="token" style="color:#999">(</span><span class="token" style="color:#690">&#x27;#opencc&#x27;</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">change</span><span class="token" style="color:#999">(</span><span class="token" style="color:#07a">function</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">36</span><span>    </span><span class="token dom" style="color:#e90">localStorage</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">setItem</span><span class="token" style="color:#999">(</span><span class="token" style="color:#690">&#x27;opencc&#x27;</span><span class="token" style="color:#999">,</span><span> event</span><span class="token" style="color:#999">.</span><span class="token property-access">target</span><span class="token" style="color:#999">.</span><span class="token property-access">value</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">37</span><span>    </span><span class="token dom" style="color:#e90">location</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">reload</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">38</span><span></span><span class="token" style="color:#999">}</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">39</span><span></span><span class="token" style="color:#999">}</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">40</span><span></span><span class="token" style="color:#999">}</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span></code></div></pre>
<p node="[object Object]" class="sm:text-xl text-lg mt-4 dark:text-gray-300">效果如下：</p>
<p node="[object Object]" class="sm:text-xl text-lg mt-4 dark:text-gray-300"><img src="https://p.sda1.dev/14/54b68f6a606d0f24cf6e52e6f530e875/QQ%E6%88%AA%E5%9B%BE20231112182613.png" class="w-11/12 lg:w-2/3 mx-auto my-3 rounded-lg" loading="lazy" alt="效果"/></p>
<div class="mt-12 mb-6"><h2 class="sm:text-3xl text-2xl dark:text-white">补遗</h2><hr class="dark:border-dashed mt-1"/></div>
<blockquote node="[object Object]" class="border-l-4 pl-4 border-gray-300 dark:border-gray-600 rounded-l-sm italic my-4">
<p node="[object Object]" class="sm:text-xl text-lg mt-4 dark:text-gray-300">The site content language (<code class="text-gray-600 dark:text-white" node="[object Object]">`<!-- -->ContentLanguage<!-- -->`</code> service in <code class="text-gray-600 dark:text-white" node="[object Object]">`<!-- -->MediaWiki\MediaWikiServices::getContentLanguage<!-- -->`</code>, based on <code class="text-gray-600 dark:text-white" node="[object Object]">`<!-- -->$wgLanguageCode<!-- -->`</code>), which <strong node="[object Object]" class="font-bold dark:text-gray-100">should generally stay the same as long as the wiki exists</strong>.</p>
</blockquote>
<p node="[object Object]" class="sm:text-xl text-lg mt-4 dark:text-gray-300">最好的方法永远是保证最开始设置正确，权宜之计终归是权宜之计。利用这个脚本，可以实现对页面内容的正确变体转换，然而，在实际使用中，还有一些问题：</p>
<ul depth="0" node="[object Object]" class="sm:text-xl text-lg list-disc pl-5 my-5 dark:text-gray-300">
<li class="ml-2 my-1">需要额外创建繁体标题重定向</li>
<li class="ml-2 my-1">不支持转换后变体的搜索</li>
</ul>
<p node="[object Object]" class="sm:text-xl text-lg mt-4 dark:text-gray-300">关于第一点，将在下一篇文章提供解决方法。关于第二点，考虑到小 wiki 对搜索正文内容的需求不是很大，暂时只能如此了。</p></div><br/><div></div><a class="float-right mt-10 sm:text-2xl text-xl text-gray-500 hover:text-black transition-colors duration-200 dark:text-gray-400 dark:hover:text-gray-100" href="/note">cd ..</a></div></main><footer class="container mx-auto text-center text-gray-700 dark:text-gray-400"><div class="flex flex-row justify-center mb-5 space-x-5"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="1.8em" height="1.8em" viewBox="0 0 24 24" class="cursor-pointer"><path fill="currentColor" fill-rule="evenodd" d="M3.5 3.25a.75.75 0 0 1 .75-.75C14.053 2.5 22 10.447 22 20.25a.75.75 0 0 1-1.5 0C20.5 11.275 13.225 4 4.25 4a.75.75 0 0 1-.75-.75zM3.5 19a2 2 0 1 1 4 0a2 2 0 0 1-4 0zm.75-9.5a.75.75 0 0 0 0 1.5a9.25 9.25 0 0 1 9.25 9.25a.75.75 0 0 0 1.5 0C15 14.313 10.187 9.5 4.25 9.5z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="1.8em" height="1.8em" viewBox="0 0 24 24" class="cursor-pointer"><path fill="currentColor" d="M4 20q-.825 0-1.412-.587Q2 18.825 2 18V6q0-.825.588-1.412Q3.175 4 4 4h16q.825 0 1.413.588Q22 5.175 22 6v12q0 .825-.587 1.413Q20.825 20 20 20ZM20 8l-7.475 4.675q-.125.075-.263.112q-.137.038-.262.038t-.262-.038q-.138-.037-.263-.112L4 8v10h16Zm-8 3l8-5H4ZM4 8v.25v-1.475v.025V6v.8v-.013V8.25V8v10Z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="1.8em" height="1.8em" cursor="pointer" viewBox="0 0 16 16"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M5.75 14.25s-.5-2 .5-3c0 0-2 0-3.5-1.5s-1-4.5 0-5.5c-.5-1.5.5-2.5.5-2.5s1.5 0 2.5 1c1-.5 3.5-.5 4.5 0c1-1 2.5-1 2.5-1s1 1 .5 2.5c1 1 1.5 4 0 5.5s-3.5 1.5-3.5 1.5c1 1 .5 3 .5 3m-5-.5c-1.5.5-3-.5-3.5-1"></path></svg></div><div class="mb-10 font-en">©<!-- -->2024<!-- -->. All rights reserved by <a href="https://github.com/omvjro" class="text-blue-500 hover:text-blue-900 transition-colors duration-300">omvjro</a>. Powered by <a href="https://github.com/qianxi0410/gossip" class="text-blue-500 hover:text-blue-900 transition-colors duration-300">Gossip</a>.</div></footer><div class="bottom-10 right-10 cursor-pointer fixed hidden lg:block"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="1.8em" height="1.8em" viewBox="0 0 24 24" class="opacity-0 duration-700 transition-opacity ease-in-out"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 19h14a2 2 0 0 0 1.84-2.75L13.74 4a2 2 0 0 0-3.5 0l-7.1 12.25A2 2 0 0 0 4.89 19"></path></svg></div></div></div><script id="__NEXT_DATA__" type="application/json" crossorigin="">{"props":{"pageProps":{"post":{"id":2,"title":"在维基农场上为初始语言并非 zh 的 MediaWiki 站点添加语言变体/简繁转换功能","created_at":"2024-05-13T05:15:12Z","updated_at":"2024-05-13T05:15:12Z","content":"在 [DOL 中文 wiki](https://degreesoflewditycn.miraheze.org/) 中，或由于初始设置失误，语言设置为 `zh-CN` 而非 `zh`。根据 [MediaWiki 文档](https://www.mediawiki.org/wiki/Manual:$wgDisableLangConversion/zh)，只有语言设置为 `zh` 才能启用自带的变体转换功能（以 `$wgDisableLangConversion` 设置）。\r\n\r\n## 用户界面语言和站点内容语言\r\n\r\n首先需由[文档](https://www.mediawiki.org/wiki/Manual:Language)明确，MediaWiki 的语言分为三种：\r\n\r\n- 站点内容语言（Site content language）\r\n- 用户界面语言（User interface language，API 调用为 `mw.user.options.values.language`）\r\n- 页面内容语言（Page content language）\r\n\r\n其中页面内容语言极少需要配置，绝大部分情况下，都默认与 `站点内容语言` 一致，在此忽略。\r\n\r\n`站点内容语言` 决定了 `html` 的 `lang` 属性，在默认情况下，也决定了 wiki 具体内容的语言，实际使用上，主要有标题（`#firstHeading`）和内容（`#mw-content-text`）两部分。\r\n\r\n`用户界面语言` 决定了基础界面的 `lang` 属性，这些基础界面也就是“用户界面消息”（User interface message）。用户界面消息大部分由 MediaWiki 自动生成，例如命名空间的“User”（`en`）和“用户”（`zh`），能够随 `用户界面语言` 改变自己改变语言；但有一部分用户界面消息来自 MediaWiki 命名空间，最常用的如 `MediaWiki:Sidebar` 为侧边栏（`#site-navigation`），其 `lang` 属性虽能随 `用户界面语言` 改变而改变，具体内容却不会自动变化，需要额外设置用户界面消息。\r\n\r\n## 清除用户界面消息缓存\r\n\r\n作为往往在每个页面都有使用的内容，用户界面消息有着强大的缓存。根据 [MediaWiki 文档](https://www.mediawiki.org/wiki/Manual:$wgLanguageCode)，更改 wiki 语言（`$wgLanguageCode`）后，需清除用户界面消息缓存，否则会无法显示新语言界面消息，或新旧语言界面消息混杂。其中提供了两种方法。\r\n\r\n在 MediaWiki 1.18 及以上，运行\r\n\r\n```shell\r\necho 'MediaWiki\\MediaWikiServices::getInstance()-\u003egetMessageCache()-\u003eclear()' | php maintenance/eval.php\r\n```\r\n\r\n在 MediaWiki 1.18 以下，则手动运行 `maintenance/rebuildmessages.php`。\r\n\r\n在 Miraheze 这样的维基农场中，往往无法如此清除缓存，需要等待很长时间自动清除，可能会对期间访问站点的用户造成困扰。\r\n\r\n## 设置 `$wgForceUIMsgAsContentMsg`\r\n\r\n经指点并查[文档](https://www.mediawiki.org/wiki/Manual:$wgForceUIMsgAsContentMsg)，亦可以设置 `$wgForceUIMsgAsContentMsg`，将用户界面消息设置为内容消息，即能够自己转换。\r\n\r\n显然，在维基农场中，也不可改动这个设置。\r\n\r\n## 编写自定义变体脚本\r\n\r\n试模拟原变体功能，在内容页面右上排按钮（`.mw-list-item`）中添加变体按钮，加入全站加载的 `MediaWiki:Common.js` 中。\r\n\r\n### opencc-js\r\n\r\n[OpenCC](https://github.com/BYVoid/OpenCC) 是非常常用的一个简繁转换工具，凭借巨大的词库，可以实现各地不同繁体的转换，故欲以此编写转换脚本。原工具为 npm 包，难以直接使用，但有衍生 JavaScript 版本 [opencc-js](https://github.com/nk2028/opencc-js)，此处则使用此版本。\r\n\r\n摘抄用法如下：\r\n\r\n```js\r\n// Set Chinese convert from Traditional (Hong Kong) to Simplified (Mainland China)\r\nconst converter = OpenCC.Converter({ from: 'hk', to: 'cn' });\r\n// Set the conversion starting point to the root node, i.e. convert the whole page\r\nconst rootNode = document.documentElement;\r\n// Convert all elements with attributes lang='zh-HK'. Change attribute value to lang='zh-CN'\r\nconst HTMLConvertHandler = OpenCC.HTMLConverter(converter, rootNode, 'zh-HK', 'zh-CN');\r\nHTMLConvertHandler.convert(); // Convert  -\u003e 汉语\r\nHTMLConvertHandler.restore(); // Restore  -\u003e 漢語\r\n```\r\n\r\n由此按照 `lang` 属性转换的特性，可以为需转换内容设置不存在的 `lang` 属性，如 `zh-to-convert`，实现不影响其他部分的转换；对于易误转换的内容，如 `textarea`，也可以设置如 `zh-not-convert` 的 `lang` 属性，随后用 `restore` 方法转回原文。\r\n\r\n特别是在 MediaWiki 中，需要转换的元素主要为标题（`#firstHeading`）、侧边栏（`#site-navigation`）、内容（`#mw-content-text`），这些部分的特点是具有 MediaWiki 根据 `站点内容语言` 或 `用户界面语言` 设定设置的 `lang` 属性；然而，`html` 同样拥有此属性，因此不能直接根据原属性转换。\r\n\r\nopencc-js 亦支持自定义词典，在 wiki 实际使用中应很有用处，但暂不研究。\r\n\r\n### 外部脚本加载问题\r\n\r\nMediaWiki 中，传统的引入外部脚本的方式为使用 `mw.loader.load`。\r\n\r\n```js\r\nmw.loader.load( 'https://cdn.jsdelivr.net/npm/opencc-js@1.0.5/dist/umd/full.js' );\r\n```\r\n\r\n然而，当网络情况不佳或脚本稍大（如 opencc-js）时，会出现未加载完成的情况。\r\n\r\n幸而，在 MediaWiki 1.33 中，新增了一种引入外部脚本的方式，为 `mw.loader.getScript`，其会传回一个 Promise 对象。无需知道 Promise 对象的含义，只需参考[示例代码](https://www.mediawiki.org/wiki/ResourceLoader/Core_modules#mw.loader.getScript)，就能实现外部脚本加载完后执行函数。\r\n\r\n```js\r\nmw.loader.getScript( 'https://cdn.jsdelivr.net/npm/opencc-js@1.0.5/dist/umd/full.js' )\r\n.then(function(){\r\n    // 之后执行的内容\r\n});\r\n```\r\n\r\n### 只支持 ES5 的屑 MediaWiki\r\n\r\n调试时可能出现报错，说明只能使用 ES5 语法。ES6 2015 年即推出，目前已经普遍支持，很容易不小心写出来。例如模板字符串、箭头函数等。\r\n\r\n\u003e 实现目前的需求，将 ES6 语法重构为 ES5 语法不是很难。对于重构困难的脚本，可以通过以 `mw.loader.load` 加载脚本的方法在 MediaWiki 中使用 ES6。\r\n\r\n## 结果\r\n\r\n以下为暂用的脚本，实现以 `localStorage` 存储用户偏好的变体转换，理论上可适用于所有 wiki，只需微调 CSS。\r\n\r\n```js\r\n// 载入 openccjs\r\nmw.loader.getScript( 'https://cdn.jsdelivr.net/npm/opencc-js@1.0.5/dist/umd/full.js' )\r\n.then(function(){\r\n$(function(){ // DOM 加载后操作\r\n\r\n// 设置转换工具，简体 -\u003e 港繁/台繁，台繁 -\u003e 简体\r\nconst cth = OpenCC.Converter({ from: 'cn', to: 'hk' });\r\nconst ttc = OpenCC.Converter({ from: 'tw', to: 'cn' });\r\nconst ctt = OpenCC.Converter({ from: 'cn', to: 'tw' });\r\n\r\n// 设置必要的 lang 属性以备后续转换\r\n$('#firstHeading').attr('lang', 'zh-to-convert');\r\n$('#site-navigation ul').attr('lang', 'zh-to-convert');\r\n$('#site-navigation h3').attr('lang', 'zh-to-convert');\r\n$('#mw-content-text').attr('lang', 'zh-to-convert');\r\nif($('textarea')) { $('textarea').attr('lang', 'zh-not-convert'); }\r\n\r\n// 检查 localStorage 并转换\r\nconst rootNode = document.documentElement;\r\nconst HTMLConvertHandler = {\r\n    \"cn\": OpenCC.HTMLConverter(ttc, rootNode, 'zh-to-convert', 'zh-CN'),\r\n    \"hk\": OpenCC.HTMLConverter(cth, rootNode, 'zh-to-convert', 'zh-HK'),\r\n    \"tw\": OpenCC.HTMLConverter(ctt, rootNode, 'zh-to-convert', 'zh-TW'),\r\n}\r\nif (localStorage.getItem('opencc')) {\r\n    HTMLConvertHandler[localStorage.getItem('opencc')].convert();\r\n    $('#opencc').val(localStorage.getItem('opencc'));\r\n}\r\n\r\n// 插入样式和按钮\r\n$('\u003cstyle\u003e.mw-list-item select {color: #68d;padding: inherit;padding-right: 2em;background-color: transparent;cursor: pointer;border: none;}.mw-list-item select:hover {border: none;}\u003c/style\u003e').appendTo('body');\r\n$('\u003cli class=\"mw-list-item\"\u003e\u003cselect name=\"opencc\" id=\"opencc\"\u003e\u003coption value=\"\"\u003e不转换\u003c/option\u003e\u003coption value=\"cn\"\u003e大陆简体\u003c/option\u003e\u003coption value=\"hk\"\u003e港澳繁体\u003c/option\u003e\u003coption value=\"tw\"\u003e台湾繁体\u003c/option\u003e\u003c/select\u003e\u003c/li\u003e').appendTo($('#p-views ul'));\r\n\r\n// 用户修改变体后，设置 localStorage 并刷新\r\n$('#opencc').change(function() {\r\n    localStorage.setItem('opencc', event.target.value);\r\n    location.reload();\r\n});\r\n});\r\n});\r\n```\r\n\r\n效果如下：\r\n\r\n![效果](https://p.sda1.dev/14/54b68f6a606d0f24cf6e52e6f530e875/QQ截图20231112182613.png)\r\n\r\n## 补遗\r\n\r\n\u003e The site content language (`ContentLanguage` service in `MediaWiki\\MediaWikiServices::getContentLanguage`, based on `$wgLanguageCode`), which **should generally stay the same as long as the wiki exists**.\r\n\r\n最好的方法永远是保证最开始设置正确，权宜之计终归是权宜之计。利用这个脚本，可以实现对页面内容的正确变体转换，然而，在实际使用中，还有一些问题：\r\n\r\n- 需要额外创建繁体标题重定向\r\n- 不支持转换后变体的搜索\r\n\r\n关于第一点，将在下一篇文章提供解决方法。关于第二点，考虑到小 wiki 对搜索正文内容的需求不是很大，暂时只能如此了。\r\n","author":"omvjro","reactions":{"url":"https://api.github.com/repos/omvjro/note/issues/2/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"labels":["published","MediaWiki"]}},"__N_SSG":true},"page":"/post/[id]","query":{"id":"在维基农场上为初始语言并非 zh 的 MediaWiki 站点添加语言变体/简繁转换功能"},"buildId":"CUaEogwWMroIdI9PZB-NQ","assetPrefix":"/note","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>